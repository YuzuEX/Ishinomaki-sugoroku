<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>çŸ³å·»ã™ã”ã‚ã</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { text-align: center; font-family: sans-serif; }
    #map { height: 80vh; width: 100%; margin-bottom: 10px; }
    button { font-size: 20px; padding: 10px 20px; margin: 5px; }
    .leaflet-popup-content { font-size: 16px; }
    #log { max-height: 15vh; overflow-y: auto; text-align: left; padding: 5px; }
  </style>
</head>
<body>
  <h1>çŸ³å·»ã™ã”ã‚ã</h1>
  <div id="map"></div>
  <button onclick="rollDice()">ğŸ² ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹</button>
  <div id="log">ã‚²ãƒ¼ãƒ é–‹å§‹ï¼</div>

  <script>
    const map = L.map('map').setView([38.4345, 141.3023], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    const places = [
      { name: "çŸ³å·»é§…", coords: [38.4345, 141.3023], info: "çŸ³å·»å¸‚ã®ç„é–¢å£", img: "images/ishinomaki_station.jpg" },
      { name: "ç«‹ç”ºå•†åº—è¡—", coords: [38.4355, 141.3030], info: "åœ°å…ƒã‚°ãƒ«ãƒ¡ãŒæ¥½ã—ã‚ã‚‹", img: "" },
      { name: "çŸ³ãƒæ£®è¬ç”»é¤¨", coords: [38.4362, 141.3071], info: "æ¼«ç”»æ–‡åŒ–ã®åšç‰©é¤¨", img: "images/mangakan.jpg" },
      { name: "åŒ—ä¸Šå·", coords: [38.4430, 141.3100], info: "å¸‚ã‚’æµã‚Œã‚‹å¤§æ²³", img: "" },
      { name: "ã‚µãƒ³ãƒ»ãƒ•ã‚¡ãƒ³é¤¨", coords: [38.3716, 141.5056], info: "å¾©å…ƒå¸†èˆ¹ã‚µãƒ³ãƒ»ãƒ•ã‚¡ãƒ³å·", img: "" },
      { name: "é‡‘è¯å±±", coords: [38.3008, 141.5985], info: "é»„é‡‘å±±ç¥ç¤¾ãŒã‚ã‚‹éœŠå³°", img: "images/kinka.jpg" },
      { name: "ç‰¡é¹¿åŠå³¶", coords: [38.2744, 141.4975], info: "è‡ªç„¶è±Šã‹ãªåŠå³¶", img: "" },
      { name: "ç¶²åœ°å³¶", coords: [38.2905, 141.4644], info: "å°ã•ãªé›¢å³¶", img: "" },
      { name: "æ¼æ¸¯ãƒ»å¸‚å ´", coords: [38.4290, 141.3065], info: "æ–°é®®ãªæµ·ã®å¹¸", img: "" },
      { name: "å¾©èˆˆç¥ˆå¿µå…¬åœ’", coords: [38.4317, 141.3120], info: "éœ‡ç½ã®è¨˜æ†¶ã‚’æœªæ¥ã¸", img: "" }
    ];

    places.forEach(p => {
      L.marker(p.coords).addTo(map).bindPopup(`<b>${p.name}</b><br>${p.info}`);
    });

    let players = [
      { name: "ã‚ãªãŸ", pos: 0, marker: null },
      { name: "CPU1", pos: 0, marker: null },
      { name: "CPU2", pos: 0, marker: null },
      { name: "CPU3", pos: 0, marker: null }
    ];

    const icon = L.icon({ iconUrl: "pawn.png", iconSize: [32,32] });
    players.forEach(p => {
      p.marker = L.marker(places[0].coords, {icon: icon}).addTo(map);
    });

    let turn = 0;
    let finished = false;

    function rollDice() {
      if (finished) return;
      if (turn !== 0) { log("ã‚ãªãŸã®ç•ªã§ã¯ã‚ã‚Šã¾ã›ã‚“"); return; }
      let dice = Math.floor(Math.random() * 6) + 1;
      movePlayer(0, dice, () => cpuTurn(1));
    }

    function movePlayer(i, dice, callback) {
      let p = players[i];
      p.pos += dice;
      if (p.pos >= places.length-1) {
        p.pos = places.length-1;
        finished = true;
        log(`ğŸ ${p.name} ãŒã‚´ãƒ¼ãƒ«ã—ã¾ã—ãŸï¼`);
      }
      let dest = places[p.pos];
      p.marker.setLatLng(dest.coords);
      let imgHtml = dest.img ? `<br><img src="${dest.img}" width="150">` : "";
      p.marker.bindPopup(`<b>${dest.name}</b><br>${dest.info}${imgHtml}`).openPopup();
      log(`${p.name} ğŸ² ${dice} â†’ ${dest.name}`);
      setTimeout(callback, 1500);
    }

    function cpuTurn(i) {
      if (finished) return;
      if (i > 3) { turn = 0; log("ğŸ‘‰ ã‚ãªãŸã®ç•ªã§ã™"); return; }
      let dice = Math.floor(Math.random() * 6) + 1;
      movePlayer(i, dice, () => cpuTurn(i+1));
    }

    function log(msg) {
      document.getElementById("log").innerHTML += "<br>" + msg;
    }
  </script>
</body>
</html>
